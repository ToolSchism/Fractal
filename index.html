<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fractal Game</title>
    <style>
        /* Tailwind-like utility classes */
        body {
            background-color: #000;
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
        }
        .container {
            width: 100%;
            max-width: 56rem;
            margin: 0 auto;
            padding: 1rem;
        }
        .canvas-container {
            width: 100%;
            max-height: 60vh;
            aspect-ratio: 4/3;
            border: 1px solid #fff;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
        }
        .stat-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .stat-item {
            background-color: #1f2937;
            padding: 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .button-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .button {
            padding: 0.5rem;
            border-radius: 0.25rem;
            flex-grow: 1;
            basis: 0;
            min-width: 150px;
            max-width: 250px;
            text-align: center;
        }
        .blue-button { background-color: #3b82f6; color: white; }
        .purple-button { background-color: #8b5cf6; color: white; }
        .gray-button { background-color: #6b7280; color: white; }
        .green-button { background-color: #10b981; color: white; }
        .upgrade-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        @media (min-width: 640px) {
            .upgrade-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        @media (min-width: 1024px) {
            .upgrade-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        .upgrade-card {
            background-color: #1f2937;
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .upgrade-button {
            width: 100%;
            padding: 0.5rem;
            border-radius: 0.25rem;
        }
        .blue-upgrade { background-color: #2563eb; color: white; }
        .green-upgrade { background-color: #16a34a; color: white; }
        .purple-upgrade { background-color: #9333ea; color: white; }
        .yellow-upgrade { background-color: #ca8a04; color: white; }
        .red-upgrade { background-color: #dc2626; color: white; }

        /* Skill Popup Styles */
        #skillPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #1f2937;
            border-radius: 0.5rem;
            padding: 1rem;
            z-index: 1000;
            max-width: 90%;
            width: 400px;
            max-height: 80%;
            overflow-y: auto;
            display: none;
        }
        .skill-popup-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
        }
        #skillPopupGrid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1rem;
        }
        .skill-popup-close {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background-color: #dc2626;
            color: white;
            border: none;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <canvas id="fractalCanvas" width="800" height="600" class="canvas-container mx-auto"></canvas>
        
        <div id="gameStats" class="stat-container">
            <span id="tokensDisplay" class="stat-item">Tokens: 0</span>
            <span id="tokenRateDisplay" class="stat-item">Rate: 0/s</span>
            <span id="fractalLevelDisplay" class="stat-item">Fractal Level: 1</span>
            <span id="prestigeDisplay" class="stat-item">Prestige: 1x</span>
        </div>
        
        <div id="playerStats" class="stat-container">
            <span id="xpDisplay" class="stat-item">XP: 0/100</span>
            <span id="levelDisplay" class="stat-item">Level: 1</span>
            <span id="skillPointsDisplay" class="stat-item">Skill Points: 0</span>
        </div>
        
        <div id="gameControls" class="button-container">
            <button id="expandButton" class="button blue-button">
                Expand Fractal (Cost: 10)
            </button>
            
            <button id="prestigeButton" class="button purple-button">
                Prestige (Req: Level 100)
            </button>
            
            <button id="autoExpandButton" class="button gray-button">
                Auto Expand: OFF
            </button>

            <button id="skillPopupButton" class="button green-button">
                Skill Tree
            </button>
        </div>

        <div id="upgradesGrid" class="upgrade-grid">
            <!-- Upgrade buttons will be dynamically added here -->
        </div>

        <!-- Skill Popup -->
        <div id="skillPopupOverlay" class="skill-popup-overlay"></div>
        <div id="skillPopup">
            <button id="skillPopupClose" class="skill-popup-close">Close</button>
            <h2 class="text-center mb-4">Skill Tree</h2>
            <div id="skillPopupGrid">
                <!-- Skill buttons will be dynamically added here -->
            </div>
        </div>
    </div>

    <script>
    class FractalGame {
        constructor() {
            this.canvas = document.getElementById('fractalCanvas');
            this.ctx = this.canvas.getContext('2d');
            
            this.tokens = 0;
            this.xp = 0;
            this.level = 1;
            this.skillPoints = 0;
            this.fractalLevel = 1;
            this.prestige = 1;
            this.autoExpand = false;

            this.upgrades = {
                tokenGeneration: 0,
                fractalComplexity: 0,
                prestigeMultiplier: 0,
                autoExpandEfficiency: 0,
                renderQuality: 0
            };

            this.initializeEventListeners();
            this.startGameLoop();
        }

        get tokenRate() {
            const baseRate = 10 * Math.pow(this.fractalLevel, 1.2) * this.prestige;
            const upgradeMultiplier = 1 + (this.upgrades.tokenGeneration * 0.2);
            return Math.floor(baseRate * upgradeMultiplier);
        }

        get upgradeCost() {
            const baseCost = 10 * Math.pow(1.5, this.fractalLevel);
            const complexityReduction = 1 - (this.upgrades.fractalComplexity * 0.1);
            return Math.floor(baseCost * complexityReduction);
        }

        get prestigeCost() {
            // Change: Prestige cost increases based on cumulative prestige levels
            const basePrestigeCost = Math.floor(100 * (1 + this.prestige));
            const prestigeMultiplier = 1 - (this.upgrades.prestigeMultiplier * 0.05);
            return Math.floor(basePrestigeCost * prestigeMultiplier);
        }

        initializeEventListeners() {
            document.getElementById('expandButton').addEventListener('click', () => this.handleExpand());
            document.getElementById('prestigeButton').addEventListener('click', () => this.handlePrestige());
            document.getElementById('autoExpandButton').addEventListener('click', () => this.toggleAutoExpand());
            
            // Skill Popup Listeners
            document.getElementById('skillPopupButton').addEventListener('click', () => this.openSkillPopup());
            document.getElementById('skillPopupClose').addEventListener('click', () => this.closeSkillPopup());
            document.getElementById('skillPopupOverlay').addEventListener('click', () => this.closeSkillPopup());

            this.createUpgradeButtons();
            this.createSkillButtons();
        }

        createSkillButtons() {
            const skillPopupGrid = document.getElementById('skillPopupGrid');
            const skills = [
                { 
                    name: 'Token Generation', 
                    type: 'tokenGeneration', 
                    effect: '+20% Token Rate',
                    color: 'blue'
                },
                { 
                    name: 'Fractal Complexity', 
                    type: 'fractalComplexity', 
                    effect: '-10% Upgrade Cost',
                    color: 'green'
                },
                { 
                    name: 'Prestige Multiplier', 
                    type: 'prestigeMultiplier', 
                    effect: '-5% Prestige Requirement',
                    color: 'purple'
                },
                { 
                    name: 'Auto Expand Efficiency', 
                    type: 'autoExpandEfficiency', 
                    effect: '+20% Auto Expand',
                    color: 'yellow'
                },
                { 
                    name: 'Render Quality', 
                    type: 'renderQuality', 
                    effect: '+Fractal Detail',
                    color: 'red'
                }
            ];

            skills.forEach(skill => {
                const skillElement = document.createElement('div');
                skillElement.className = `bg-gray-800 p-4 rounded flex flex-col items-center`;
                skillElement.innerHTML = `
                    <h3 class="flex items-center mb-2">
                        ${skill.name}
                        <span class="ml-2 text-sm text-gray-400" id="${skill.type}SkillLevel">
                            (Level: 0)
                        </span>
                    </h3>
                    <button 
                        id="${skill.type}SkillButton"
                        class="bg-${skill.color}-600 p-2 rounded w-full"
                    >
                        Upgrade (${skill.effect})
                    </button>
                `;
                skillPopupGrid.appendChild(skillElement);

                document.getElementById(`${skill.type}SkillButton`).addEventListener('click', 
                    () => this.handleUpgrade(skill.type)
                );
            });
        }

        openSkillPopup() {
            document.getElementById('skillPopup').style.display = 'block';
            document.getElementById('skillPopupOverlay').style.display = 'block';
        }

        closeSkillPopup() {
            document.getElementById('skillPopup').style.display = 'none';
            document.getElementById('skillPopupOverlay').style.display = 'none';
        }

        createUpgradeButtons() {
            // This method is now mainly for backwards compatibility
            // The upgrade buttons are created in createSkillButtons
            return;
        }

        handleUpgrade(upgradeType) {
            if (this.skillPoints > 0) {
                this.upgrades[upgradeType]++;
                this.skillPoints--;
                this.updateDisplay();
            }
        }

        handleExpand() {
            if (this.tokens >= this.upgradeCost) {
                this.tokens -= this.upgradeCost;
                this.fractalLevel++;
                this.updateDisplay();
            }
        }

        handlePrestige() {
            if (this.level >= this.prestigeCost) {
                this.tokens = 0;
                this.fractalLevel = 1;
                this.xp = 0;
                this.level = 1;
                this.skillPoints = 0;
                this.upgrades = {
                    tokenGeneration: 0,
                    fractalComplexity: 0,
                    prestigeMultiplier: 0,
                    autoExpandEfficiency: 0,
                    renderQuality: 0
                };
                this.prestige *= (1.5 + this.upgrades.prestigeMultiplier * 0.1);
                this.updateDisplay();
            }
        }

        toggleAutoExpand() {
            this.autoExpand = !this.autoExpand;
            document.getElementById('autoExpandButton').textContent = 
                this.autoExpand ? 'Auto Expand: ON' : 'Auto Expand: OFF';
            document.getElementById('autoExpandButton').className = 
                this.autoExpand 
                ? 'button green-button'
                : 'button gray-button';
        }

        drawFractal() {
            const ctx = this.ctx;
            const width = this.canvas.width;
            const height = this.canvas.height;

            ctx.clearRect(0, 0, width, height);
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 1 + (this.upgrades.renderQuality * 0.5);

            const drawKochSnowflake = (x1, y1, x2, y2, depth) => {
                if (depth === 0) {
                    ctx.beginPath();
                    ctx.moveTo(x1, y1);
                    ctx.lineTo(x2, y2);
                    ctx.stroke();
                    return;
                }

                const dx = x2 - x1;
                const dy = y2 - y1;
                const dist = Math.sqrt(dx * dx + dy * dy);
                const unitX = dx / dist;
                const unitY = dy / dist;

                const thirdX = x1 + dx / 2 + Math.sqrt(3) / 2 * (unitY * dist / 3);
                const thirdY = y1 + dy / 2 - Math.sqrt(3) / 2 * (unitX * dist / 3);

                drawKochSnowflake(x1, y1, x1 + dx / 3, y1 + dy / 3, depth - 1);
                drawKochSnowflake(x1 + dx / 3, y1 + dy / 3, thirdX, thirdY, depth - 1);
                drawKochSnowflake(thirdX, thirdY, x1 + 2 * dx / 3, y1 + 2 * dy / 3, depth - 1);
                drawKochSnowflake(x1 + 2 * dx / 3, y1 + 2 * dy / 3, x2, y2, depth - 1);
            };

            const size = 400 * Math.sqrt(this.fractalLevel);
            const centerX = width / 2;
            const centerY = height / 2;

            const maxDepth = Math.min(this.fractalLevel, 6 + this.upgrades.renderQuality);

            drawKochSnowflake(
                centerX - size / 2, 
                centerY + size / (2 * Math.sqrt(3)), 
                centerX + size / 2, 
                centerY + size / (2 * Math.sqrt(3)), 
                maxDepth
            );
        }

        gameLoop() {
            this.tokens += this.tokenRate / 10;

            this.drawFractal();

            // XP and Leveling
            const xpGain = Math.floor(this.tokenRate / 10);
            const nextLevelXp = this.level * 100;

            if (this.xp + xpGain >= nextLevelXp) {
                this.level++;
                this.skillPoints++;
                this.xp = 0;
            } else {
                this.xp += xpGain;
            }

            // Auto-expand logic
            const autoExpandMultiplier = 1 + (this.upgrades.autoExpandEfficiency * 0.2);
            if (this.autoExpand && this.tokens >= this.upgradeCost * autoExpandMultiplier) {
                this.tokens -= this.upgradeCost * autoExpandMultiplier;
                this.fractalLevel++;
            }

            this.updateDisplay();
        }

        updateDisplay() {
            document.getElementById('tokensDisplay').textContent = `Tokens: ${Math.floor(this.tokens)}`;
            document.getElementById('tokenRateDisplay').textContent = `Rate: ${this.tokenRate}/s`;
            document.getElementById('fractalLevelDisplay').textContent = `Fractal Level: ${this.fractalLevel}`;
            document.getElementById('prestigeDisplay').textContent = `Prestige: ${this.prestige.toFixed(2)}x`;
            
            document.getElementById('xpDisplay').textContent = `XP: ${Math.floor(this.xp)}/${this.level * 100}`;
            document.getElementById('levelDisplay').textContent = `Level: ${this.level}`;
            document.getElementById('skillPointsDisplay').textContent = `Skill Points: ${this.skillPoints}`;

            // Update skill levels in both popup and original location
            Object.keys(this.upgrades).forEach(upgradeName => {
                const skillLevelElement = document.getElementById(`${upgradeName}SkillLevel`);
                if (skillLevelElement) {
                    skillLevelElement.textContent = `(Level: ${this.upgrades[upgradeName]})`;
                }
            });

            // Update expand and prestige buttons
            document.getElementById('expandButton').textContent = `Expand Fractal (Cost: ${this.upgradeCost})`;
            document.getElementById('prestigeButton').textContent = `Prestige (Req: Level ${this.prestigeCost})`;
        }

        startGameLoop() {
            setInterval(() => this.gameLoop(), 100);
        }
    }

    // Initialize the game when the page loads
    window.addEventListener('load', () => {
        new FractalGame();
    });
    </script>
</body>
</html>
